---
title: "RDSSAT"
author: "MichelleCGM"
date: "2021-05-11"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction
# The DSSAT package source code is hosted in an open-source project on Github 
# (https://github.com/palderman/DSSAT), it is also compiled in R.4.0.5
# Install DSSAT package then load the package using the library() function
# Full use of the DSSAT package requires an installation of DSSAT-CSM, which can be obtained from the  
# DSSAT Foundation (https://dssat.net/)
# or by compiling it from source code (https://github.com/DSSAT/dssat-csm-os).
# When the DSSAT package is loaded, it attempts to locate the local DSSAT-CSM installation and identify # the proper executable name.
# It then prints a start up message indicating what file path was found
# (if any) and prompting the user to reset the path (by setting the value of the DSSAT.CSM option variable) if the located file path is incorrect.


```{r}
library(DSSAT)
library(tidyverse)
library(hydroGOF)
library(corrplot)
library(zoo)
library(rsq)
library(lemon)
library(gridExtra)
library(grid)
library(gridtext)
here::i_am("analysis/RunDSSATmakeout.Rmd")
```

```{r}
options(DSSAT.CSM = 'dscsm047')
```

Read original fileX
```{r}
file_x <- read_filex(here::here("data", "CSfiles", "UYUM1801.CSX"))
```

Modify fileX
```{r}
file_x <- read_filex(here::here("UYAG1701.CSX"))
#Define Weather Station with weather data
file_x$FIELDS <-
  file_x$FIELDS %>% 
  mutate_cond(L==1, WSTA=("UYAG1704"))
#Input SOIL ANALYSIS date
file_x$`SOIL ANALYSIS` <-
  file_x$`SOIL ANALYSIS` %>%
  mutate_cond(A==1, SADAT=as.POSIXct("2018-07-28"))
#Input INITIAL CONDITIONS date
file_x$`INITIAL CONDITIONS` <-
  file_x$`INITIAL CONDITIONS` %>%
  mutate_cond(C==1, ICDAT=as.POSIXct("2018-07-28"))
#Input PLANTING DETAILS DATE
file_x$`PLANTING DETAILS` <-
  file_x$`PLANTING DETAILS` %>%
  mutate_cond(P==1, PDATE=as.POSIXct("2018-07-28"))
#Input IRRIGATION AND WATER MANAGEMENT
file_x$`IRRIGATION AND WATER MANAGEMENT` <-
  file_x$`IRRIGATION AND WATER MANAGEMENT` %>%
  mutate_cond(I==1, IDATE=as.POSIXct("2018-07-28"))
#Input HARVEST DETAILS
file_x$`HARVEST DETAILS` <-
  file_x$`HARVEST DETAILS` %>%
  mutate_cond(H==1, HDATE=as.POSIXct("2019-07-28"))
#Input SIMULATION CONTROLS
file_x$`SIMULATION CONTROLS` <-
  file_x$`SIMULATION CONTROLS` %>%
  mutate_cond(N==1, 
              SDATE=as.POSIXct("2018-07-28"),
              PFRST=as.POSIXct("2018-07-28"),
              PLAST=as.POSIXct("2018-07-28"),
              HLAST=as.POSIXct("2019-07-28"))
#Write filex
write_filex(file_x, (here::here("xfilecomp", "UYUM1801.CSX")), drop_duplicate_rows = TRUE, force_std_fmt = TRUE)
```

```{r}
read_filex(here::here("UYAG1701.CSX"))
write_dssbatch("UYAG1701.CSX", trtno = 1:67)
run_dssat(suppress_output = TRUE) 
```






#Prepare input data for DSSAT_CSM running
#Load and read phenotype file (UYT_GXE_phene.csv)

#Making a table of Selected variables to use and make abbreviations for renaming
    #Year=studyYear
    #Pltdate=plantingDate
    #Harvdate=harvestDate
    #Location=locationName
    #Cul = germplasmName
    #Dmat = dry matter content percentage|CO_334:0000092
    #FTop = fresh shoot weight measurement in kg per plot|CO_334:0000016
    #FHarv = fresh storage root weight per plot|CO_334:0000012
    #HIX 
