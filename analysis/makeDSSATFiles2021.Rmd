---
title: "makeDSSATFiles2021"
author: "Michelle"
date: "2021-11-29"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages 
```{r load packages, message=FALSE}
ip <- installed.packages()
packages_used <- c("workflowr", "tidyverse", "here", "lubridate")
for (package in packages_used){
  if (!(package %in% ip[,"Package"])) install.packages(package)
}
library(tidyverse)
here::i_am("analysis/makeDSSATFiles2021.Rmd")
```


### Read the GxE trials file  
```{r Read GxE trials}
colClasses <- readr::read_csv(here::here("data/IITA2021_CABASE", "colClasses.csv"))
# colClasses[14, 2] <- colClasses[15, 2] <- "Date"
colString <- paste0(substring(colClasses$colClass, 1, 1), collapse="")
uytAl <- readr::read_csv(here::here("data/IITA2021_CABASE", "UYT_GXE_pheno.csv"), 
                                     col_types=colString)#"UYT_GXE_pheno.csv"

uytAll <- uytAl %>% filter(!(studyName %in% c("17.GS.C2.setB.UYT.36.AG",
  "18.GS.C2.setA.UYT.36.KN",
  "18.GS.C2.setB.UYT.36.KN",
  "18.GS.C2.setB.UYT.36.OT",
  "18.GS.C2.UYT.36.setA.AG",
  "19.GS.C2.UYT.36.setA.MK",
  "19.GS.C2.UYT.36.setA.ZA",
  "19.GS.C2.UYT.36.setB.AG",
  "19.GS.C2.UYT.36.setB.ON",
 "19.GS.C2.UYT.36.setB.ZA",
 "20.GS.C2.UYT.36.setB.IB"))) 
#uytAll20 <- uytAll %>% rename(Pharperplot = "plant stands harvested counting|CO_334:0000010") %>% 
 #          filter(Pharperplot == 20)
trials <- uytAll %>% distinct(studyYear, locationName)#uytAll20
```


The input files to DSSAT need formatted dates and number of days after planting
```{r Planting Harvest Dates}
makeDateStrings <- function(trial){
  plant <- parse_date(trial$plantingDate[1], format="%Y-%B-%d")
  harvest <- parse_date(trial$harvestDate[1], format="%Y-%B-%d")
  yearPlant <- lubridate::year(plant)
  yearHarv <- lubridate::year(harvest)
  DAP <- julian(harvest) - julian(plant)
  plantString <- paste0(substring(lubridate::year(plant), 3, 4),
    julian(plant, 
    origin=lubridate::as_date(paste0(lubridate::year(plant), "-01-01"))))
  harvestString <- paste0(substring(lubridate::year(harvest), 3, 4),
    julian(harvest, 
    origin=lubridate::as_date(paste0(lubridate::year(harvest), "-01-01"))))
  return(list(plntStr=plantString, harvStr=harvestString, DAP=DAP))
}

# Uniform trial name based on trial data
makeTrialName <- function(trial){
  loc <- trial$locationName[1]
  year <- trial$studyYear[1]
  # Put in EXP.DETAILS
  trialName <- paste0("UY", substring(toupper(loc), 1, 2), year%%100, 
                   "01")
  return(trialName)
}
```

The .CUL file for DSSAT has plant architecture parameters for each cultivar. 
It also defines the cultivar number (UC prefix) linked to the cultivar names. 
This function defines a cultivar number for all accessions in the 
`UYT_GXE_pheno.csv` file. It will set all the ecotypes to 990016 which is 
WestAfricaWhite
```{r Make Cultivar File}
template <- "CSYCA048.CUL"
ucStart <- 20 # What UC number should the file start at?
varNameSpace <- 21 # How many spaces are available for the cultivar name?
# What to end the row with once you have defined the UC and culitvar name
# NOTE: this row end includes the ecotype, 990029 in this case
rowEnd <- ". 990016 250.0 200.0 200.0 200.0   2.5   2.0   2.0   1.5   350   220  1000  0.33  1.20  4.00   2.0"
uniCul <- uytAll %>% distinct(germplasmName)#uytAll20

makeUCstring <- function(ucNum){
  pad <- paste0(rep("0", 3-floor(log10(ucNum))), collapse="")
  return(paste0("UC", pad, ucNum))
}
padCulName <- function(culName){
  pad <- paste0(rep(" ", varNameSpace-nchar(culName)), collapse="")
  return(paste0(culName, pad))
}

curCUL <- read_lines(here::here("data/DSSATtempfile", template))
ucss <- makeUCstring(ucStart)
lineStart <- grep(ucss, curCUL)
curCUL <- curCUL[1:(lineStart-1)]

for (i in 1:nrow(uniCul)){
  ucString <- makeUCstring(ucStart - 1 + i)
  curCUL <- c(curCUL, paste0(ucString, " ", padCulName(uniCul[i,1]), rowEnd))
}

newCULname <- paste0(template, "_", lubridate::today())
write_lines(curCUL, here::here("data/DSSATtempfile", newCULname))

# Add the ucNames to the germplasmNames: they will be needed later
uniCul <- uniCul %>% mutate(
  ucName=sapply(ucStart - 1 + 1:nrow(uniCul), makeUCstring))
```

Function to take data from a trial extracted from `uytAll` and make a new 
.CSX file with it
```{r Make Xfile}
makeXfile <- function(trial){
  template <- "UYAB1901.CSX"
  xFile <- read_lines(here::here("data/DSSATtempfile", template))
  # Put in new file name
  fileName <- makeTrialName(trial)
  xFile <- gsub("UYAB1901CS", paste0(fileName, "CS"), xFile, fixed=T)
  xFile <- gsub("UYAB1901", fileName, xFile, fixed=T)
  # Put in new location
  xFile <- gsub("ABUJA", toupper(trial$locationName[1]), xFile, fixed=T)
  # Figure out number of TNAME
  culThisTrial <- trial %>% dplyr::distinct(germplasmName)
  culThisTrial <- culThisTrial[order(culThisTrial$germplasmName),]
  nCul <- nrow(culThisTrial)
  culThisTrial <- culThisTrial %>% mutate(culNum=1:nCul)
  varNameSpace <- 26 # How many spaces are available for the cultivar name?
  makeTrtRow <- function(culNum, culName){
    rowEnd <- "  1  0  0  1  0  0  0  0  0  0  1  1"
    cn <- paste0(ifelse(culNum > 9, "", " "), culNum)
    pad <- paste0(rep(" ", varNameSpace-nchar(culName)), collapse="")
    return(paste0(cn, " 1 1 0 ", culName, pad, cn, rowEnd))
  }
  makeCulRow <- function(culNum, culName){
    cn <- paste0(ifelse(culNum > 9, "", " "), culNum)
    inGeno <- uniCul %>% filter(germplasmName==culName) %>% pull(ucName)
    return(paste0(cn, " CS ", inGeno, " ", culName))
  }
  # WARNING this is specific to this template
  strtTrt <- grep("*TREATMENTS", xFile, fixed=T)+2
  endTrt <- grep("*CULTIVARS", xFile, fixed=T)-2
  xFile <- xFile[-(strtTrt:endTrt)]
  trtInsert <- mapply(makeTrtRow, culNum=culThisTrial$culNum,
                      culName=culThisTrial$germplasmName)
  xFile <- R.utils::insert(xFile, ats=strtTrt, value=trtInsert)
  
  strtCul <- grep("*CULTIVARS", xFile, fixed=T)+2
  endCul <- grep("*FIELDS", xFile, fixed=T)-2
  xFile <- xFile[-(strtCul:endCul)]
  culInsert <- mapply(makeCulRow, culNum=culThisTrial$culNum,
                      culName=culThisTrial$germplasmName)
  xFile <- R.utils::insert(xFile, ats=strtCul, value=culInsert)
                
  write_lines(xFile, here::here("data", "CSfiles", paste0(fileName, ".CSX")))
  return(culThisTrial)
}
```

Function to take data from a trial extracted from `uytAll` and make a new 
.CSA file with it
```{r Make Afile}
makeAfile <- function(trial){
  template <- "UYAB1901.CSA"
  aFile <- read_lines(here::here("data/DSSATtempfile", template))
  # Put in new file name
  fileName <- makeTrialName(trial)
  aFile <- gsub("UYAB1901CS", paste0(fileName, "CS"), aFile, fixed=T)
  # Take the mean of DMC and the mean of FYLD and multiply
  # For the tops, I'm just going to take the weight and divide by two
  cloneMeans <- trial %>% group_by(germplasmName) %>% summarise(across(
    c('dry matter content percentage|CO_334:0000092',
      'fresh shoot weight measurement in kg per plot|CO_334:0000016',
      'fresh storage root weight per plot|CO_334:0000012'
      ), 
    mean, na.rm=T))
  cloneMeans <- cloneMeans[order(cloneMeans$germplasmName),]
  cloneMeans <- cloneMeans %>% rename(
    dmc='dry matter content percentage|CO_334:0000092',
    fyld='fresh storage root weight per plot|CO_334:0000012',
    shtwt='fresh shoot weight measurement in kg per plot|CO_334:0000016')
  cloneMeans <- cloneMeans %>% mutate(HWAM=round(dmc/100*fyld*10000/16),
                                      CWAM=round(shtwt*10000/16/3),
                                      "@TRNO"=1:nrow(cloneMeans))
                                      #B1DAP=40,
                                      #B5DAP=160)
  plant <- parse_date(trial$plantingDate[1], format="%Y-%B-%d")
  plantString <- paste0(substring(lubridate::year(plant), 3, 4),
    julian(plant, 
    origin=lubridate::as_date(paste0(lubridate::year(plant), "-01-01"))))
  PREP_A1 <- read.csv("data/IITA2021_Mich/Mich2021.csv")
  PREP_A2 <- PREP_A1 %>% mutate(germplasmName = accession_name) %>%
                      dplyr::select(-plant_number, -rep_number, -stem_nu, 
                               -accession_name, -LAIm, -NODLT, -L.IR) %>%
                       group_by(germplasmName)  %>%
                        dplyr::summarise(across(c(LAIX, BR.S, L.SX, B1D, B2D, B3D, B4D), 
                                        mean, na.rm=TRUE)) %>%
                          mutate(LAIX = round(LAIX),
                                B1DAP = round(if_else(B1D < 60, 60, B1D)),
                                B2DAP = round(if_else(B2D < 60, 60, B2D)), 
                                B3DAP = round(if_else(B3D < 60, 60, B3D)),
                                B4DAP = round(if_else(B4D < 60, 60, B4D))) %>%
                           mutate(B1DAT =  as.numeric(plantString) + B1DAP,
                                  B1DAT = if_else(B1DAT > 17365 & B1DAT < 18000, B1DAT + 635, B1DAT),
                                  B1DAT = if_else(B1DAT > 18365 & B1DAT < 19000, B1DAT + 635, B1DAT),
                                  B1DAT = if_else(B1DAT > 19365 & B1DAT < 20000, B1DAT + 635, B1DAT),
                                B2DAT = as.numeric(plantString) + B2DAP, 
                                B2DAT = if_else(B2DAT > 17365 & B2DAT < 18000, B2DAT + 635, B2DAT),
                                  B2DAT = if_else(B2DAT > 18365 & B2DAT < 19000, B2DAT + 635, B2DAT),
                                  B2DAT = if_else(B2DAT > 19365 & B2DAT < 20000, B2DAT + 635, B2DAT),
                                B3DAT = as.numeric(plantString) + B3DAP,
                                B3DAT = if_else(B3DAT > 17365 & B3DAT < 18000, B3DAT + 635, B3DAT),
                                  B3DAT = if_else(B3DAT > 18365 & B3DAT < 19000, B3DAT + 635, B3DAT),
                                  B3DAT = if_else(B3DAT > 19365 & B3DAT < 20000, B3DAT + 635, B3DAT),
                                B4DAT = as.numeric(plantString) + B4DAP, 
                                  B4DAT = if_else(B4DAT > 17365 & B4DAT < 18000, B4DAT + 635, B4DAT),
                                  B4DAT = if_else(B4DAT > 18365 & B4DAT < 19000, B4DAT + 635, B4DAT),
                                  B4DAT = if_else(B4DAT > 19365 & B4DAT < 20000, B4DAT + 635, B4DAT)) %>%
                                #"BR#S" = round(BR.S, digits = 1),
                                #"L#SX" = round(L.SX, digits = 1)) %>%
                           dplyr::select(germplasmName, B1DAT, B2DAT, B3DAT, B4DAT, LAIX)
                             #"BR#S","L#SX")
  PREP_A <- PREP_A2[order(PREP_A2$germplasmName),]
  PREP_A2 <- PREP_A %>% mutate("@TRNO"=1:nrow(PREP_A2))
  toWrite1 <- left_join(cloneMeans, PREP_A)
  toWrite <- toWrite1 %>% dplyr::select("@TRNO", B1DAT, B2DAT, B3DAT, B4DAT, HWAM, CWAM, LAIX)#, "BR#S","L#SX")#, B1DAP, B5DAP)
  
  filePath <- here::here("data", "CSfiles", paste0(fileName, ".CSA"))
  write_lines(aFile[1:2], filePath)
  dateComment <- paste0("! File last edited on ", date())
  write_lines(dateComment, filePath, append=T)
  write_lines("", filePath, append=T)
  write_delim(toWrite, filePath, append=T, col_names=T, na="-99")
  return(toWrite)
}
```

Function to take data from a trial extracted from `uytAll` and make a new 
.CST file with it
```{r Make Tfile}
makeTfile <- function(trial){
  template <- "UYAB1901.CST"
  tFile <- read_lines(here::here("data/DSSATtempfile", template))
  # Put in new file name
  fileName <- makeTrialName(trial)
  tFile <- gsub("UYAB1901CS", paste0(fileName, "CS"), tFile, fixed=T)
  dt <- makeDateStrings(trial)
  
    MICHE <- trial %>% group_by(germplasmName) %>% summarise(across(
    c('dry matter content percentage|CO_334:0000092',
       'fresh storage root weight per plot|CO_334:0000012',
      'fresh shoot weight measurement in kg per plot|CO_334:0000016'
      ),
  mean, na.rm=T))
   MICHE <- MICHE[order(MICHE$germplasmName),]
   
  PREP_A1 <- read.csv("data/IITA2021_Mich/Mich2021.csv")
  PREP_T1 <- PREP_A1 %>% mutate(germplasmName = accession_name,
                                "L#IR" = round(L.IR, digits = 2),
                                "L#SX" = round(L.SX, digits = 1),
                                 LALD = round(LAIm, digits = 1),
                                 DAP = 140) %>%
                              dplyr::select(germplasmName, "L#IR","L#SX", LALD, DAP) %>%
                              group_by(germplasmName)
  PREP_T1 <- PREP_T1[order(PREP_T1$germplasmName),]
  #Clonessai <- cloneMeans %>% dplyr::select(-"@TRNO")
 # toWrite2 <- left_join(Clonessai, PREP_T1)
  #PREP_T1$TRNOE <- match(PREP_T1$germplasmName, unique(PREP_T1$germplasmName))
#CULTH <- PREP_T1 %>% dplyr::select(germplasmName, TRNOE)
  #MICHE <- MICHE %>% mutate(TRNO=1:nrow(MICHE))

  gNmToTrtNo <- function(gNm){
    return(culThisTrial %>% filter(germplasmName==gNm) %>% pull(culNum))
  }
  trtNo <- sapply(MICHE$germplasmName, gNmToTrtNo)
  
  MICHE <- MICHE %>% mutate(TRNO=trtNo)#, CWAD=round(shtwt*10000/16/2),
                            #DAP=dt$DAP, DATE=dt$harvStr)
 #toWrite <- trial %>% dplyr::select(TRNO, germplasmName)#, DAP)#, CWAD, DATE)
  toWrite3 <- left_join(MICHE, PREP_T1)
  toWrite <- toWrite3 %>% dplyr::select(TRNO, "L#IR", "L#SX", LALD, DAP)
  #toWrite1 <- PREP_T1 %>% dplyr::select(TRNO, "L#IR", "L#SX", LALD, DAP)
  filePath <- here::here("data", "CSfiles", paste0(fileName, ".CST"))
  write_lines(tFile[1:2], filePath)
  dateComment <- paste0("! File last edited on ", date())
  write_lines(dateComment, filePath, append=T)
  write_lines("", filePath, append=T)
  write_lines("@TRNO L#IR, L#SX LALD DAP", filePath, append=T)#CWAD DAP DATE"
  writeOneTrt <- function(trtNo){
   write_lines(paste0(trtNo, " 0 0 0 0"), filePath, append=T)
   toWrite %>% filter(TRNO==trtNo) %>% 
     write_delim(path=filePath, na="-99", append=T)
  }
  theTrtNo <- toWrite %>% distinct(TRNO) %>% unlist
  dummy <- sapply(theTrtNo, writeOneTrt)
  return(toWrite)
}
```

Now go through and make all the CS_ files
NOTE: This fails for 2018 Ibadan because no harvest date was recorded for
that trial
```{r Make all CS_ files}
makeCS_file <- function(yearLoc){
  print(yearLoc)
  trial <- uytAll %>% filter(studyYear==yearLoc[1] & locationName==yearLoc[2])
  culThisTrial <<- makeXfile(trial)
  toWriteA <- makeAfile(trial)
  toWriteT <- makeTfile(trial)
  return(list(culThisTrial, toWriteA, toWriteT))#list(culThisTrial, toWriteA, toWriteT))
}
makeAllFiles <- apply(trials, 1, makeCS_file)
```
